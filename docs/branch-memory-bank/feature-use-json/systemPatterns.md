# システムパターン

## 技術的決定事項

### JSONベースのドキュメント形式の導入

#### コンテキスト
現在のメモリバンクはMarkdown形式のドキュメントを使用していますが、構造化データの管理や検索、フィルタリングが難しい課題があります。特に、メタデータの抽出や特定の情報へのアクセスが非効率です。

#### 決定事項
メモリバンクのドキュメントをJSON形式でも保存・読み込みできるようにし、以下の方針で実装します：

1. `.json`拡張子を持つファイルはJSON形式として処理
2. 既存の`.md`拡張子のファイルは引き続きMarkdown形式として処理
3. JSONドキュメントは以下の基本構造を持つ：
   ```json
   {
     "metadata": {
       "title": "ドキュメントタイトル",
       "lastModified": "2025-03-16T10:00:00.000Z",
       "tags": ["tag1", "tag2"]
     },
     "content": "ドキュメントの主要コンテンツ"
   }
   ```
4. Zodスキーマを使用したJSONバリデーションを実装
5. Markdown <-> JSON変換ユーティリティの提供

#### 影響
- 構造化されたデータへのアクセスと操作が容易になる
- 高度な検索・クエリ機能が実装可能になる
- メタデータの管理が改善される
- 既存のMarkdownとの互換性を維持しながら、段階的に移行できる
- コードの複雑性は増加するが、データ処理の柔軟性が向上する

### Markdownパーサーの実装

#### コンテキスト
既存のMarkdownファイルからJSONへの変換と、JSONからMarkdownへの変換が必要です。特に、Markdownのフロントマター（YAMLヘッダー）や見出し構造を正確に解析して構造化データに変換する機能が求められています。

#### 決定事項
シンプルなMarkdownパーサーユーティリティを実装し、以下の機能を提供します：

1. Markdownからタイトル（H1見出し）を抽出
2. セクション（H2, H3レベル）の検出と構造化
3. リスト項目の抽出とJSONへの変換
4. フロントマターがある場合は解析してメタデータとして扱う
5. コードブロックの保持

外部ライブラリに依存せず、シンプルな正規表現ベースのパーサーを実装します。

#### 影響
- Markdownとの互換性を保ちながらJSON形式に移行可能
- 既存のドキュメントを自動的に変換可能
- 外部依存関係を増やさずに実装できる
- 複雑なMarkdown構文の全てをサポートするわけではないため、一部の高度な形式は失われる可能性がある

### リポジトリパターンの拡張

#### コンテキスト
現在のリポジトリインターフェースはMarkdownファイルを前提としていますが、JSON形式のサポートを追加するには拡張が必要です。

#### 決定事項
既存のリポジトリインターフェースを拡張し、ファイル拡張子に基づいて適切な処理を行うように実装します：

1. `DocumentPath`クラスの拡張：`.json`拡張子の検出と適切な処理
2. リポジトリの読み書きメソッドでファイル形式に応じた処理の分岐
3. 必要に応じて自動的な形式変換の提供
4. 新しいクエリメソッドの追加（JSON形式の特性を活かした検索機能）

#### 影響
- 既存のコードベースとの互換性を維持しながら新機能を追加可能
- ドメインロジックを変更せずにインフラストラクチャレベルで対応可能
- 将来的な拡張性の向上（他の形式も同様のパターンで追加可能）
- テストの複雑性は増加するが、型安全性と堅牢性が向上

### JSON形式のスキーマ検証

#### コンテキスト
JSON形式のドキュメントは柔軟性が高い反面、不正な形式のデータが混入するリスクがあります。スキーマ検証によって構造の整合性を保証する必要があります。

#### 決定事項
Zodライブラリを使用して、JSONドキュメントのスキーマ定義と検証を実装します：

1. 基本的なドキュメント構造のスキーマ定義
2. メタデータの検証ルールの詳細化
3. 読み込み時のバリデーションと自動修正機能
4. 書き込み前の検証による不正データの防止
5. 柔軟な日付形式の対応（既存のFlexibleDateSchemaを活用）

#### 影響
- データの整合性とバリデーションが強化される
- 型安全性が向上しエラーを早期発見できる
- 既存のZodスキーマインフラを再利用できる
- 若干のパフォーマンスオーバーヘッドが発生する

## 関連ファイルとディレクトリ構造

```
/
├── src/
│   ├── domain/
│   │   ├── entities/
│   │   │   ├── MemoryDocument.ts  // 拡張が必要
│   │   │   └── DocumentPath.ts    // 拡張が必要
│   │   └── repositories/
│   │       └── MemoryBankRepository.ts  // インターフェース拡張が必要
│   ├── application/
│   │   └── usecases/
│   │       ├── ReadDocumentUseCase.ts   // 形式ごとの分岐処理追加
│   │       └── WriteDocumentUseCase.ts  // JSON対応の追加
│   ├── infrastructure/
│   │   └── repositories/
│   │       └── FileSystemMemoryBankRepository.ts  // 実装拡張
│   ├── schemas/
│   │   └── MemoryDocumentSchema.ts  // JSONスキーマ定義の追加
│   └── utils/
│       ├── markdown-parser.ts  // 新規作成
│       └── json-converter.ts   // 新規作成
└── tests/
    └── utils/
        ├── markdown-parser.test.ts  // 新規作成
        └── json-converter.test.ts   // 新規作成
```
