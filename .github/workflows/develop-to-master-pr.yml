name: Create PR from develop to master

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing_pr=$(gh pr list --base master --head develop --state open --json number -q '.[0].number')
          if [ ! -z "$existing_pr" ]; then
            echo "Existing PR found: #$existing_pr"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¤‰æ›´ã®ç¨®é¡ã‚’åˆ¤æ–­
          commit_message="${{ github.event.head_commit.message }}"
          if [[ "$commit_message" =~ ^feat:|^feature: ]]; then
            pr_title="âœ¨ feat: Merge develop into master"
            label="enhancement"
          elif [[ "$commit_message" =~ ^fix: ]]; then
            pr_title="ğŸ› fix: Merge develop into master"
            label="bug"
          else
            pr_title="ğŸ”„ chore: Merge develop into master"
            label="chore"
          fi

          # å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆ
          changes=$(git log master..develop --pretty=format:'- %s' --reverse)

          # è¨€èªã‚’åˆ¤æ–­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªï¼‰
          if [[ "$GITHUB_REPOSITORY" =~ .*-en$ ]]; then
            template_file="src/templates/develop-to-master-pr-template-en.md"
          else
            template_file="src/templates/develop-to-master-pr-template.md"
          fi

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§å¤‰æ›´å±¥æ­´ã‚’æŒ¿å…¥
          body=$(cat "$template_file" | sed "s|{{CHANGES}}|$changes|g")

          # PRã‚’ä½œæˆ
          gh pr create \
            --base master \
            --head develop \
            --title "$pr_title" \
            --body "$body" \
            --label "auto-generated" \
            --label "$label"

          echo "Pull Request created successfully!"
