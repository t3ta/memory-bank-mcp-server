# システムパターン

## 技術的決定事項

### テストコードの改善

#### コンテキスト

テストコードにおいて、テスト対象のメソッド自体をモックしている問題があった。これではテストの意味がなくなり、実際の実装の挙動を検証できない。

#### 決定事項

依存するサービスのみをモックし、テスト対象のメソッド自体はモックしないよう修正した。特に以下の点を改善：

1. テスト対象メソッドの直接モックを避け、依存するサービス（FileSystemServiceなど）を適切にモック化
2. 複雑な依存関係を持つクラスをテストする場合は、依存クラス自体をモック化する（例：FileSystemGlobalMemoryBankRepositoryのテストではFileSystemMemoryDocumentRepositoryをモック化）
3. エラーケースのテストはtry-catchパターンを使用して安定性を向上

#### 影響

- テストの信頼性が向上し、実際の実装の挙動をより正確に検証できるようになった
- テストが内部実装の変更に対して堅牢になった
- メソッド呼び出しの順序や回数などを正確に検証できるようになった

### エラーハンドリングの一貫性

#### コンテキスト

エラーハンドリングのアプローチが一貫していない部分があり、特にテストでエラーケースを再現する方法が安定していなかった。

#### 決定事項

エラーハンドリングのテストを標準化し、以下のパターンを採用：

1. 生のErrorからInfrastructureErrorへの変換を検証するケースでは、try-catchパターンを使用
2. モック化した依存サービスでエラーを発生させ、それがリポジトリレベルで適切に処理されることを検証
3. テスト対象のメソッドが特定の型（InfrastructureErrorなど）のエラーをスローすることを期待する場合は明示的に型を検証

#### 影響

- エラーハンドリングのテストがより安定して動作するようになった
- エラー変換ロジックの検証が簡単になった
- テストがより読みやすく、意図が明確になった

### テストモックの簡素化

#### コンテキスト

テストコードが複雑で読みにくい箇所があり、特にモックの設定が複雑になっていた。

#### 決定事項

以下の原則に従ってテストコードを簡素化：

1. jest.mockを使用して依存モジュールを丸ごとモック化する（例：FileSystemMemoryDocumentRepository）
2. 個別のメソッドのモックは、テストケース内でのみ定義し、テスト間での影響を避ける
3. スパイを使用する場合は、必ずafterEachまたはtry-finallyブロックでリストアする

#### 影響

- テストコードがより読みやすく、メンテナンスしやすくなった
- テスト間の干渉が減少した
- モックの設定ミスによるエラーが減少した