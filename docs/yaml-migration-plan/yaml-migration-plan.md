# YAMLへの移行計画

## 概要

現在のメモリバンクはJSONで管理されていますが、人間にとっての可読性を向上させるためにYAMLへの移行を計画しています。この文書では、JSONからYAMLへの移行計画について詳細に説明します。

## 現状分析

### 現在のアーキテクチャ

現在のメモリバンクは以下の特徴を持っています：

- JSONベースのドキュメント管理
- Zodを使用したスキーマ検証
- MarkdownからJSONへの移行機能が既に実装されている
- ドキュメントタイプごとに異なるスキーマが定義されている

### 既存のコード資産

- `src/migration/MarkdownToJsonMigrator.ts`: MarkdownからJSONへの移行機能
- `src/schemas/json-document.ts`: JSONドキュメントのスキーマ定義
- `src/infrastructure/repositories/file-system/FileSystemMemoryDocumentRepository.ts`: ドキュメントの保存と読み取り
- `src/infrastructure/storage/FileSystemService.ts`: ファイルシステム操作

## 移行の目的と利点

### 移行の目的

- 人間にとっての可読性の向上
- 編集のしやすさの向上
- 設定ファイルとしての使いやすさの向上

### YAMLの利点

1. **可読性**: YAMLはJSONよりも可読性が高く、特に複雑なネストされた構造を持つデータに適しています
2. **コメント**: YAMLはコメントをサポートしており、ドキュメントに説明を追加できます
3. **参照と継承**: YAMLはアンカーと参照をサポートしており、重複を減らすことができます
4. **複数行文字列**: YAMLは複数行の文字列を簡単に扱うことができます
5. **インデントベースの構造**: 中括弧やカンマの代わりにインデントを使用するため、構文エラーが少なくなります

## 技術的アプローチ

### 必要なパッケージ

- `js-yaml`: JavaScriptでYAMLを扱うための標準的なライブラリ
- `zod-to-json-schema`: Zodスキーマからの変換に使用（必要に応じて）

### 実装アプローチ

1. **YAMLドキュメントクラスの作成**:
   - `JsonDocument`クラスを参考に`YamlDocument`クラスを実装
   - YAMLの読み取りと書き込み機能を提供

2. **マイグレーターの実装**:
   - `JsonToYamlMigrator`クラスを実装（`MarkdownToJsonMigrator`を参考に）
   - JSONファイルをYAMLに変換する機能を提供

3. **スキーマ検証の拡張**:
   - 既存のZodスキーマをYAMLでも使用できるように拡張
   - YAMLファイルの検証機能を実装

4. **リポジトリの拡張**:
   - `FileSystemMemoryDocumentRepository`を拡張してYAMLファイルをサポート
   - YAMLファイルの読み取りと書き込み機能を追加

5. **CLIコマンドの追加**:
   - `migrate-to-yaml`コマンドを追加
   - バッチ変換のためのオプションを提供

## ファイル構造と命名規則

### ファイル拡張子

- `.yaml`または`.yml`を使用（`.yaml`を推奨）
- 既存のJSONファイルと同じディレクトリ構造を維持

### 命名規則

- ファイル名は既存のJSONファイルと同じ命名規則を使用
- 例: `branchContext.json` → `branchContext.yaml`

## 移行プロセス

### 段階的アプローチ

1. **開発フェーズ**:
   - YAMLサポートの実装
   - テストの作成と実行
   - ドキュメントの更新

2. **移行フェーズ**:
   - 既存のJSONファイルをYAMLに変換
   - 両方の形式を一時的にサポート
   - 新しいドキュメントはYAMLで作成

3. **完全移行フェーズ**:
   - JSONサポートの廃止（オプション）
   - すべてのドキュメントをYAMLに統一

### バックアップと検証

- 移行前に既存のJSONファイルをバックアップ
- 変換後のYAMLファイルの内容を検証
- 自動テストによる検証

## 実装計画

### フェーズ1: 基本実装（2週間）

1. **依存関係の追加**:
   ```bash
   npm install js-yaml @types/js-yaml
   ```

2. **YAMLドキュメントクラスの実装**:
   - `src/domain/entities/YamlDocument.ts`の作成
   - JSONとYAML間の変換メソッドの実装

3. **マイグレーターの実装**:
   - `src/migration/JsonToYamlMigrator.ts`の作成
   - 単一ファイルとディレクトリの変換機能の実装

4. **リポジトリの拡張**:
   - `src/infrastructure/repositories/file-system/FileSystemMemoryDocumentRepository.ts`の拡張
   - YAMLファイルの読み取りと書き込み機能の追加

### フェーズ2: CLIとテスト（2週間）

1. **CLIコマンドの追加**:
   - `src/cli/commands/MigrateToYamlCommand.ts`の作成
   - コマンドラインオプションの実装

2. **テストの実装**:
   - 単体テストの作成
   - 統合テストの作成
   - E2Eテストの作成

### フェーズ3: 統合と検証（1週間）

1. **既存機能との統合**:
   - MCPサーバーとの統合
   - 既存のAPIとの互換性確保

2. **ドキュメントの更新**:
   - ユーザーガイドの更新
   - APIドキュメントの更新

3. **全体テストと検証**:
   - すべてのテストの実行
   - 手動検証

## テスト計画

### 単体テスト

1. **YAMLドキュメントクラスのテスト**:
   - YAMLの読み取りと書き込みのテスト
   - JSONとYAML間の変換テスト
   - スキーマ検証のテスト

2. **マイグレーターのテスト**:
   - 単一ファイルの変換テスト
   - ディレクトリの変換テスト
   - エラーハンドリングのテスト

### 統合テスト

1. **CLIコマンドのテスト**:
   - コマンドラインオプションのテスト
   - 実際のファイルを使用したテスト

2. **MCPサーバーとの統合テスト**:
   - YAMLファイルの読み取りと書き込みのテスト
   - APIを通じたYAMLファイルの操作テスト

### E2Eテスト

1. **JSONからYAMLへの移行テスト**:
   - 既存のJSONファイルをYAMLに変換するテスト
   - 変換後のYAMLファイルの検証

2. **MarkdownからYAMLへの移行テスト**:
   - MarkdownファイルをYAMLに直接変換するテスト
   - 変換後のYAMLファイルの検証

3. **バッチ移行テスト**:
   - 複数のファイルを一括で変換するテスト
   - 変換後のYAMLファイルの検証

4. **エラーハンドリングテスト**:
   - 無効なファイルの処理テスト
   - エラーメッセージの検証

5. **パフォーマンステスト**:
   - 大規模なファイルの変換テスト
   - 変換速度の測定

## リスクと対策

### 潜在的なリスク

1. **互換性の問題**:
   - YAMLとJSONの間で完全な互換性を確保できない可能性
   - 対策: 厳密な変換ルールの定義と徹底的なテスト

2. **パフォーマンスの問題**:
   - YAMLの解析と生成がJSONよりも遅い可能性
   - 対策: パフォーマンステストの実施と最適化

3. **移行の複雑さ**:
   - 大量のファイルの移行が複雑になる可能性
   - 対策: 段階的な移行と自動化ツールの開発

4. **ユーザーの混乱**:
   - 両方の形式が存在することによるユーザーの混乱
   - 対策: 明確なドキュメントと移行ガイドの提供

## タイムライン

### 予定スケジュール

1. **フェーズ1: 基本実装** (2週間)
   - 依存関係の追加: 1日
   - YAMLドキュメントクラスの実装: 5日
   - マイグレーターの実装: 5日
   - リポジトリの拡張: 3日

2. **フェーズ2: CLIとテスト** (2週間)
   - CLIコマンドの追加: 3日
   - 単体テストの実装: 4日
   - 統合テストの実装: 4日
   - E2Eテストの実装: 3日

3. **フェーズ3: 統合と検証** (1週間)
   - 既存機能との統合: 2日
   - ドキュメントの更新: 2日
   - 全体テストと検証: 3日

**合計期間**: 約5週間

## 実装上の注意点

1. **グローバルメモリバンクへの書き込み問題**:
   - 現在のMCPサーバーでは、`write_global_memory_bank`ツールを使用してグローバルメモリバンクに書き込む際に問題が発生する可能性があります
   - YAMLサポートを実装する際には、この問題を解決するために以下の点に注意する必要があります:
     - JSONの形式とスキーマの検証を厳密に行う
     - エラーハンドリングを強化する
     - ファイルシステムの権限を確認する

2. **既存のコードとの互換性**:
   - 現在のコードベースは`FileSystemMemoryDocumentRepository`を中心に構築されています
   - YAMLサポートを追加する際には、既存のコードとの互換性を維持するために、同じインターフェースを実装する必要があります

3. **スキーマ検証**:
   - 現在のシステムはZodを使用してJSONスキーマを検証しています
   - YAMLファイルも同じスキーマ検証を通過する必要があります

## 結論

YAMLへの移行は、メモリバンクの可読性と使いやすさを向上させるための重要なステップです。この計画に従って実装を進めることで、スムーズな移行が可能になります。段階的なアプローチと徹底的なテストにより、リスクを最小限に抑えながら移行を完了させることができます。
