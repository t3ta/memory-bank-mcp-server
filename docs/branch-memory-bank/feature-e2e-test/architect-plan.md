# テスト構造リファクタリング計画

## 現状分析

### 問題点

1. **テストファイルの配置場所に一貫性がない**:
   - `tests/integration/api/branch-controller.test.ts` - 現在の統合テスト（インタフェースレイヤー）
   - `src/interface/controllers/__tests__/BranchController.test.ts` - モックベースの新しいユニットテスト
   - `tests/unit/interface/controllers/BranchController.test.ts` - おそらく移行中のファイル

2. **テストの種類と構造が混在**:
   - 一部のテストは詳細なコメントと分かりやすい構造がある
   - 他のテストはコメントが少なく構造も不明確

3. **重複するテストコード**:
   - 同じコンポーネントを異なる方法でテストするコードが複数存在

4. **インポートパスの問題**:
   - 相対パスによるインポートと絶対パスによるインポートの混在
   - `src/` のようなエイリアスを使用しているテストと使用していないテストがある

### 進行中の対応

1. `docs/test-directory-refactoring.md` で定義された新しいディレクトリ構造への移行
2. クリーンアーキテクチャの層に合わせたテストの整理
3. テストの種類（ユニット、統合、E2E）による明確な分離
4. モックベースのテスト手法の導入（特にインターフェースレイヤー）

## 解決策

### テストの種類と配置場所の整理

1. **ユニットテスト（ `tests/unit/` ）**:
   - ドメインレイヤー: `tests/unit/domain/`
   - アプリケーションレイヤー: `tests/unit/application/`
   - インターフェースレイヤー: `tests/unit/interface/`
   - インフラストラクチャレイヤー: `tests/unit/infrastructure/`
   - 共有ユーティリティ: `tests/unit/shared/`

2. **統合テスト（ `tests/integration/` ）**:
   - APIレベルの統合テスト: `tests/integration/api/`
   - ユースケースレベルの統合テスト: `tests/integration/usecase/`
   - リポジトリの統合テスト: `tests/integration/repositories/`

3. **E2Eテスト（ `tests/e2e/` ）**:
   - 完全なエンドツーエンドテスト

### コントローラーテストの配置場所に関する決定

コントローラーテストの配置場所に関して、以下の3つの選択肢があります：

#### 選択肢1: `src/interface/controllers/__tests__/`
- **利点**: テスト対象のコードの近くに配置されるためナビゲーションが容易
- **欠点**: ソースディレクトリ内にテストコードが混在し、ビルド時に除外する必要がある
- **適合**: 主にユニットテスト向き（モックを多用）

#### 選択肢2: `tests/unit/interface/controllers/`
- **利点**: クリーンアーキテクチャの構造と一致し、ソースコードとテストの分離が明確
- **欠点**: テスト対象コードからの相対的な距離が遠い
- **適合**: ユニットテスト向き（モックを多用）

#### 選択肢3: `tests/integration/api/`
- **利点**: 統合テストとしての性質を明確にし、APIレベルのテストに適している
- **欠点**: モックを使用したユニットテストには適していない
- **適合**: 統合テスト向き（実際のコンポーネントを使用）

### 推奨アプローチ

**ハイブリッドアプローチ**:

1. **ユニットテスト**: `tests/unit/interface/controllers/BranchController.test.ts`
   - モックを多用した純粋なユニットテスト
   - コントローラーの個々のメソッドをテスト
   - ユースケースやプレゼンターのモックを使用

2. **統合テスト**: `tests/integration/api/branch-controller.test.ts`
   - 実際のリポジトリとユースケースを使用した統合テスト
   - エンドツーエンドのAPIフローをテスト
   - ファイルシステムのような外部依存のみをモック

3. **_src_ ディレクトリ内のテストを避ける**: 
   - `src/interface/controllers/__tests__/` のファイルは、`tests/unit/interface/controllers/` に移動
   - ソースコードとテストコードを明確に分離

## 実施計画

### フェーズ1: 配置場所の決定と標準化

1. **コントローラーテストの配置場所を決定する**
   - ユニットテスト: `tests/unit/interface/controllers/`
   - 統合テスト: `tests/integration/api/`

2. **既存のテストファイルの移動（必要な場合）**
   - `src/interface/controllers/__tests__/BranchController.test.ts` → `tests/unit/interface/controllers/BranchController.test.ts`
   - `tests/integration/api/branch-controller.test.ts` はそのまま維持（ただし内容は整理する）

### フェーズ2: テストコードの整理と標準化

1. **テスト内容の重複を解消する**
   - ユニットテスト: コントローラー内のロジックとエラーハンドリングに焦点
   - 統合テスト: 実際のファイルシステム操作と結果の検証に焦点

2. **テストコードのスタイルとコメントを標準化する**
   - 各テストファイルの冒頭に目的と対象を明記
   - テストケースの命名規則を統一
   - テストシナリオの構成（Arrange-Act-Assert）を明確に

### フェーズ3: インポートパスとテスト設定の整理

1. **インポートパスの標準化**
   - 絶対パス（`src/`）を優先して使用
   - 相対パスを必要に応じて修正

2. **Jest設定の最適化**
   - テストディレクトリ構造の変更に合わせて設定を調整
   - モジュールエイリアスの設定を確認

## 実装スケジュール

1. **フェーズ1**（今日）:
   - 配置場所の決定
   - ファイル移動のステップを計画

2. **フェーズ2**（明日〜数日）:
   - テストコードの整理
   - テストの重複除去
   - コメント追加と標準化

3. **フェーズ3**（〜1週間）:
   - インポートパスの修正
   - Jest設定の調整
   - 残りのテストに移行パターンを適用
