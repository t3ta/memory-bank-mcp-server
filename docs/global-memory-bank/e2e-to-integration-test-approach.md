# E2E から Integration テストへの移行アプローチ

tags: #testing #architecture #integration-tests

## 概要

当初のE2Eテストアプローチから、より効率的で安定した統合テストへの移行方針をまとめたドキュメントです。この移行によりテスト実行の安定性と効率が向上します。

## 背景

Memory Bank MCP Serverのテスト戦略は当初、完全なエンドツーエンド（E2E）テストを目指していました。しかし、実装を進める中で以下の課題が明らかになりました：

1. **サーバープロセス管理の複雑さ**:
   - テスト毎のサーバー起動/停止によるオーバーヘッド
   - プロセス間通信の不安定性
   - テスト間の分離が難しい

2. **実行時間と信頼性**:
   - 全テストの実行に時間がかかる
   - 環境要因による不安定性
   - CI環境での再現性の問題

3. **デバッグの難しさ**:
   - 障害発生時の原因特定が困難
   - 細かなテスト調整が難しい

## 新しいアプローチ: 統合テスト

上記の課題を解決するため、より直接的な統合テスト方式に移行します：

### 基本方針

1. **コンポーネント直接テスト**:
   - コントローラ、リポジトリ、ユースケースを直接インスタンス化
   - サーバープロセスを経由せず、内部コンポーネントを直接検証
   - テスト環境の完全な制御を可能に

2. **テスト分離**:
   - 各テスト用に独立した一時ディレクトリを使用
   - テストコンテキストの明確な分離
   - クリーンアップメカニズムの強化

3. **ファイルシステム検証**:
   - ファイルシステム操作の直接検証
   - コントローラ出力とファイルシステム状態の両方を検証
   - パフォーマンス向上と信頼性確保

### 実装構造

```
tests/
  ├── integration/
  │   ├── setup.ts                 # テスト環境セットアップ用共通ファイル
  │   ├── controllers/             # コントローラーレベルの統合テスト
  │   │   ├── branch-controller.test.ts
  │   │   └── global-controller.test.ts
  │   ├── repositories/            # リポジトリレベルの統合テスト
  │   ├── simple/                  # シンプルな単体機能テスト
  │   │   └── file-system.test.ts  # 基本的なファイルシステム操作テスト
  │   └── markdown-to-json/        # 特定機能の統合テスト
  │       └── json-operations-completeness.test.ts
  ├── unit/                        # 純粋な単体テスト
  ├── utils/                       # テスト用ユーティリティ
  │   └── clean-temp.js            # 一時ディレクトリクリーンアップ用
  └── .jest-cache/                 # Jestキャッシュディレクトリ
```

### 利点

1. **実行速度の向上**:
   - サーバー起動オーバーヘッドの削減
   - 並列実行の効率化

2. **安定性向上**:
   - プロセス間通信の問題解消
   - 環境依存の低減

3. **デバッグの容易化**:
   - 問題の局所化が容易
   - より詳細なエラー情報

4. **メンテナンス性向上**:
   - テストコードの簡素化
   - テストのモジュール性向上

## 実装戦略

1. **段階的移行**:
   - 既存のE2Eテストを統合テストに段階的に移行
   - 同等の機能カバレッジを維持

2. **テストヘルパーの充実**:
   - テスト環境構築の共通化
   - クリーンアップの確実な実行

3. **型安全性の確保**:
   - 適切な型ガードを用いたレスポンス処理
   - ユニオン型の適切な処理

## 将来的な発展

1. **CI/CD統合の強化**:
   - GitHub Actionsでの最適化
   - 並列実行の最大化

2. **テストカバレッジの拡充**:
   - エッジケースのカバレッジ向上
   - エラー条件のテスト強化

3. **パフォーマンステスト**:
   - 大規模データでのパフォーマンス検証
   - 境界条件での挙動確認
