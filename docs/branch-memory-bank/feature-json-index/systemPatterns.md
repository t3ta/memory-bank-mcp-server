# システムパターン

## 技術的決定事項

### JSONベースのタグインデックス形式

#### コンテキスト

タグを使った検索を高速化するためにタグインデックスをJSON形式で永続化する必要があります。既存のインデックス機能は一時的なメモリ内のみでした。

#### 決定事項

タグをキー、ドキュメントパスの配列を値とするシンプルなJSONオブジェクト形式でタグインデックスを実装します。これにより、特定のタグを持つドキュメントを高速に特定できるようになります。

#### 影響

- タグベースの検索が高速化される
- アプリケーション再起動後もインデックスが維持される
- 将来的なデータベース移行への道筋ができる
- JSONファイルのサイズが大きくなる可能性がある
- 頻繁な更新によるディスクI/Oが増加する

### ブリッジパターンによる互換性維持

#### コンテキスト

既存のV1実装と新しいV2実装を共存させつつ、徐々に移行していく必要があります。

#### 決定事項

ブリッジパターンを採用し、FileSystemTagIndexRepositoryV1Bridgeを実装してV1とV2の間を仲介させます。

#### 影響

- 既存コードを壊さずに新機能を追加できる
- 徐々に移行できるため段階的なリファクタリングが可能
- 若干の複雑性が増す
- 一時的に両方の実装を維持する必要がある

### リポジトリ責任分担

#### コンテキスト

タグインデックスの更新・保存・読み込み処理をどのクラスが担当するかを決める必要があります。

#### 決定事項

IBranchMemoryBankRepositoryとIGlobalMemoryBankRepositoryを拡張してインデックス操作のメソッドを追加し、ブリッジクラスを通じて既存の実装との互換性を維持します。

#### 影響

- 責任の所在が明確になる
- リポジトリごとにタグインデックスを管理できる
- 共通処理の重複を避けるためブリッジクラスを活用する
- インターフェースが若干肥大化する

### TypeScriptインポートパスの扱い

#### コンテキスト

コンパイル後のJavaScriptファイルとTypeScriptソースファイルのインポートパスでの整合性を取る必要があります。

#### 決定事項

インポートパスの拡張子を統一し、TypeScriptのコンパイル設定とも整合性を取ります。ただし、コード中では拡張子なしのインポート記法を使用します。

#### 影響

- コンパイルエラーを防げる
- 一貫性のあるインポートスタイルが確保される
- チーム間でのインポート記法の標準化が進む
- コンパイラオプションに適切な設定が必要になる