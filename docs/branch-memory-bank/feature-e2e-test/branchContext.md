# ブランチコンテキスト: feature/e2e-test

## 目的

Memory Bank MCP Serverのエンドツーエンドテストを実装し、テストディレクトリ構造をクリーンアーキテクチャの原則に合わせて再編成するためのブランチです。これにより、テストコードの管理性とメンテナンス性が向上します。

## ユーザーストーリー

1. **テスト基盤の構築**: サーバーの起動・管理、クライアント通信、ユーティリティなどのテスト基盤を構築する
2. **コアメモリ操作のテスト**: メモリバンク操作（読み書き）の機能をテストする
3. **メタデータ・コンテキスト操作のテスト**: ルール取得や最近のブランチ取得などの機能をテストする
4. **エラー処理とエッジケースのテスト**: 異常系や境界値のテストを行う
5. **テスト構造の整理**: クリーンアーキテクチャに合わせたテストディレクトリ構造の再編成を行う

## 技術的課題

1. **ESM/CommonJS互換性問題**: MCPのSDKがESM形式を採用しているのに対し、テスト環境はCommonJSベース
2. **サーバープロセスの管理**: テスト間でサーバープロセスの効率的な管理
3. **JSON-RPC通信の安定性**: サーバーとのJSON-RPC通信の安定性確保とエラー処理
4. **テストディレクトリ構造の統一**: クリーンアーキテクチャに合わせた一貫したテスト構造の実現

## テストディレクトリ構造

```
tests/
  ├── unit/                     # ユニットテスト
  │   ├── domain/              # ドメインレイヤーのテスト
  │   ├── application/         # アプリケーションレイヤーのテスト
  │   │   └── usecases/       # ユースケースのテスト
  │   │       ├── branch/     # ブランチ関連のユースケース
  │   │       ├── common/     # 共通ユースケース
  │   │       ├── global/     # グローバル関連のユースケース
  │   │       └── json/       # JSON関連のユースケース
  │   └── interface/          # インターフェースレイヤーのテスト
  ├── integration/             # 統合テスト
  │   ├── api/               # APIレベルの統合テスト（コントローラー）
  │   └── usecase/          # ユースケースレベルの統合テスト
  │       ├── markdown-to-json/  # マークダウンからJSONへの変換テスト
  │       ├── repositories/      # リポジトリの統合テスト
  │       └── infrastructure/    # インフラストラクチャの統合テスト
  └── e2e/                    # エンドツーエンドテスト
```

## 次回の作業に必要な情報

### 1. 前回の進捗状況

- コントローラーテストの配置場所を標準化完了:
  - ユニットテスト: `tests/unit/interface/controllers/`
  - 統合テスト: `tests/integration/api/`
- `src/interface/controllers/__tests__/`ディレクトリを削除
- `tests/unit/interface/controllers/BranchController.test.ts`のインポートパスを修正
- テストの実行確認済み

### 2. 次のステップ

- 残りのテストファイルのマッピングと移動計画作成
  - 現在のディレクトリ構造とファイル一覧の確認
  - 新しいディレクトリ構造へのマッピング表作成
  - ファイル移動の優先順位付け
  
- テストの標準化
  - コメントとドキュメンテーションの充実化
  - インポートパスの標準化（`src/`からの絶対パス）
  - Arrange-Act-Assert パターンの明確化

- 実行スクリプトの整備
  - 特定カテゴリのテストのみ実行するためのnpmスクリプト
  - CI/CD向けのテスト実行コマンド

### 3. 重要なファイル

- `docs/test-directory-refactoring.md`: テストディレクトリ構造の定義
- `tests/unit/interface/controllers/BranchController.test.ts`: 修正済みのユニットテスト
- `tests/integration/api/branch-controller.test.ts`: 統合テスト
- `package.json`: テスト実行スクリプトの定義場所
- `jest.config.ts`: Jestのメイン設定ファイル
- `tests/integration/jest.config.ts`: 統合テスト用の設定ファイル

### 4. 検討事項

- 残りのテストファイルのカテゴリ分け方法
- 重複するテストケースの整理
- 削除すべき古いテストの特定
- ユニットテストと統合テストの境界の明確化

### 5. 最終目標

- すべてのテストが適切なディレクトリに配置される
- インポートパスが標準化される
- テストの実行が効率化される
- テストカバレッジが向上する
- クリーンアーキテクチャの原則に沿ったテスト構造になる
