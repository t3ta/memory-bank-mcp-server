# CommonJS移行計画 - E2Eテスト対応

## 目的
Memory Bank MCP ServerのE2Eテスト環境をCommonJSに移行し、テストの安定稼働を実現する

## アプローチ
段階的なCommonJS移行を実施し、優先的にテスト環境の安定化を図る

## フェーズ1: 設定調整

### 1.1 package.jsonの更新
- [ ] `"type": "module"` の削除
- [ ] ESM固有のスクリプトコマンドの調整
- [ ] 必要なdevDependenciesの確認と追加
- [ ] Node.js互換性設定の確認

### 1.2 tsconfig.jsonの確認
- [x] `"module": "commonjs"` の設定確認
- [x] `"moduleResolution": "node"` の設定確認
- [x] ESM固有の設定が削除されていることを確認

### 1.3 Jest設定の最適化
- [x] Jest設定ファイルがCommonJS形式 (jest.config.cjs) になっていることを確認
- [ ] moduleNameMapperの調整（必要に応じて）
- [ ] transformの設定最適化
- [ ] テストタイムアウト設定の確認

## フェーズ2: テストコード修正

### 2.1 ヘルパーモジュールの変換
- [ ] serverManager.ts の変換
  - [ ] import文をrequireに変更
  - [ ] export文をmodule.exportsに変更
- [ ] mcp-client.ts の変換
  - [ ] import文をrequireに変更
  - [ ] export文をmodule.exportsに変更
- [ ] test-utils.ts の変換
  - [ ] import文をrequireに変更
  - [ ] export文をmodule.exportsに変更

### 2.2 テストファイルの変換
- [ ] 各テストファイル (.test.ts) のimport文変換
- [ ] テスト内のESM固有の構文をCommonJS互換に変更
- [ ] 非同期処理の扱いを確認・調整

### 2.3 セットアップファイルの修正
- [ ] setup.ts の変換
- [ ] 関連するヘルパーファイルの参照方法を調整

## フェーズ3: テスト構造最適化

### 3.1 サーバー通信改善
- [ ] サーバープロセス起動方法の改善
- [ ] JSON-RPCクライアント通信の安定化
- [ ] レスポンスパーシングの改善
- [ ] エラーハンドリングの強化

### 3.2 テスト分離とクリーンアップ
- [ ] テスト環境の完全な分離方法の実装
- [ ] 確実なクリーンアップ処理の実装
- [ ] テスト間の依存関係の排除

### 3.3 パフォーマンス最適化
- [ ] 長時間実行テストの最適化
- [ ] サーバー起動の効率化（可能な場合は再利用）

## フェーズ4: 検証と文書化

### 4.1 テスト実行の検証
- [ ] 全テスト実行での検証
- [ ] エッジケースの確認
- [ ] カバレッジの確認

### 4.2 文書化
- [ ] 移行内容のドキュメント化
- [ ] テスト実行方法の更新
- [ ] 今後のメンテナンスガイドライン作成

## コミットメント

現段階では、フェーズ1と2に集中し、E2Eテストが安定的に動作するようにすることを優先する。
フェーズ3と4は、基本的なテスト機能が動作するようになった後で取り組む。
